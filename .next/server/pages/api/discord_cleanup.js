"use strict";(()=>{var e={};e.id=877,e.ids=[877],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},1384:(e,t,r)=>{r.r(t),r.d(t,{config:()=>P,default:()=>m,routeModule:()=>y});var a={};r.r(a),r.d(a,{default:()=>h});var n=r(1802),o=r(7153),i=r(6249);function s(e){return new Promise(t=>setTimeout(t,e))}async function l(e,t,r,a=0){let n=await fetch(`https://discord.com/api/v10${e}`,{...t,headers:{Authorization:`Bot ${r}`,"Content-Type":"application/json",...t.headers||{}}});if(429===n.status){let o=Number(n.headers.get("Retry-After"))||1;if(await s((o+.5)*1e3),a<5)return l(e,t,r,a+1)}return n}function u(e){try{let t=BigInt(e);return Number(t>>22n)+14200704e5}catch{return 0}}async function d(e,t){let r=await l(`/channels/${e}/threads/active`,{method:"GET"},t);if(!r.ok)return[];let a=await r.json();return a?.threads||[]}async function c(e,t,r,a){let n=new URLSearchParams;a&&n.set("before",a),n.set("limit","50");let o=await l(`/channels/${e}/threads/archived/${r}?${n.toString()}`,{method:"GET"},t);if(!o.ok)return{threads:[],hasMore:!1};let i=await o.json(),s=i?.threads||[],u=s.map(e=>e.thread_metadata?.archive_timestamp).filter(Boolean),d=u.length?u.sort()[0]:void 0;return{threads:s,hasMore:!!i?.has_more,beforeNext:d}}async function f(e,t,r,a){let n;let o=[];for(let i=0;i<6;i++){let{threads:i,hasMore:s,beforeNext:l}=await c(e,t,r,n);if(o.push(...i),!s||!l)break;n=l;let u=i.map(e=>e.thread_metadata?.archive_timestamp).filter(Boolean).map(e=>Date.parse(e)).sort((e,t)=>e-t)[0];if(u&&u<a)break}return o}async function p(e,t){let r=await l(`/channels/${e}`,{method:"DELETE"},t);return 404===r.status||r.ok}async function h(e,t){try{if("POST"!==e.method)return t.status(405).json({ok:!1,error:"POST only"});let r=process.env.DISCORD_BOT_TOKEN||"",a=process.env.DISCORD_CHANNEL_IDS||"",n=Number(process.env.THREAD_TTL_HOURS||e.body?.ttlHours||168),o=!!e.body?.privateOnly,i=null,l=e.body?.channelIds;if(Array.isArray(l)?i=l.map(e=>String(e)).filter(Boolean):"string"==typeof l&&(i=l.split(",").map(e=>e.trim()).filter(Boolean)),!r)return t.status(200).json({ok:!1,error:"Missing DISCORD_BOT_TOKEN"});let c=i&&i.length>0?i:a.split(",").map(e=>e.trim()).filter(Boolean);if(!c.length)return t.status(200).json({ok:!1,error:"No channelIds provided (set DISCORD_CHANNEL_IDS or pass channelIds in body)"});let h=Date.now()-36e5*n,m=0,P=[];for(let e of c){let t=await d(e,r),a=o?t.filter(e=>12===e.type):t;for(let e of(m+=a.length,a)){let t=u(e.id);t&&t<h&&P.push(e.id)}let n=await f(e,r,"private",h),i=o?[]:await f(e,r,"public",h),s=[...n,...i];for(let e of(m+=s.length,s)){let t=u(e.id);t&&t<h&&P.push(e.id)}}P=Array.from(new Set(P));let y=0,_=0;for(let e=0;e<P.length;e+=4){let t=P.slice(e,e+4);for(let e of(await Promise.all(t.map(async e=>await p(e,r)))))e?y++:_++;await s(300)}t.status(200).json({ok:!0,scanned:m,considered:P.length,deleted:y,failed:_,ttlHours:n})}catch(e){t.status(200).json({ok:!1,error:e?.message||String(e)})}}let m=(0,i.l)(a,"default"),P=(0,i.l)(a,"config"),y=new n.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/discord_cleanup",pathname:"/api/discord_cleanup",bundlePath:"",filename:""},userland:a})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=1384);module.exports=r})();