"use strict";(()=>{var t={};t.id=48,t.ids=[48],t.modules={145:t=>{t.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},1467:t=>{t.exports=import("@vercel/kv")},8844:t=>{t.exports=import("ethers")},6249:(t,e)=>{Object.defineProperty(e,"l",{enumerable:!0,get:function(){return function t(e,r){return r in e?e[r]:"then"in e&&"function"==typeof e.then?e.then(e=>t(e,r)):"function"==typeof e&&"default"===r?e:void 0}}})},8596:(t,e,r)=>{r.a(t,async(t,n)=>{try{r.r(e),r.d(e,{config:()=>c,default:()=>u,routeModule:()=>f});var a=r(1802),s=r(7153),o=r(6249),i=r(3923),l=t([i]);i=(l.then?(await l)():l)[0];let u=(0,o.l)(i,"default"),c=(0,o.l)(i,"config"),f=new a.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/eth",pathname:"/api/eth",bundlePath:"",filename:""},userland:i});n()}catch(t){n(t)}})},3923:(t,e,r)=>{r.a(t,async(t,n)=>{try{r.r(e),r.d(e,{default:()=>R});var a=r(8844),s=t([a]);a=(s.then?(await s)():s)[0];let b=process.env.RPC_URL||"https://carrot.megaeth.com/mafia/rpc/203gha2ymvvv8531d14umthkq9ug0ct7z3b8am7b",E=(process.env.CONTRACT_ADDRESS||"0xae2afe4d192127e6617cfa638a94384b53facec1").toLowerCase(),v="0xccc938abc01344413efee36b5d484cedd3bf4ce93b496e8021ba021fed9e2725",A=new Map,T=[];function o(t,e){for(A.has(t)||T.push(t),A.set(t,e);T.length>120;){let t=T.shift();void 0!==t&&A.delete(t)}}let I=!!(process.env.KV_REST_API_URL||process.env.UPSTASH_REDIS_REST_URL),M=null;async function i(){return I?(!process.env.KV_REST_API_URL&&process.env.UPSTASH_REDIS_REST_URL&&(process.env.KV_REST_API_URL=process.env.UPSTASH_REDIS_REST_URL),!process.env.KV_REST_API_TOKEN&&process.env.UPSTASH_REDIS_REST_TOKEN&&(process.env.KV_REST_API_TOKEN=process.env.UPSTASH_REDIS_REST_TOKEN),M||(M=(await Promise.resolve().then(r.bind(r,1467))).kv),M):null}async function l(t){try{let e=await i();if(!e)return null;return await e.get(`day:${t}`)||null}catch{return null}}async function u(t,e){try{let r=await i();if(!r)return;await r.set(`day:${t}`,e)}catch{}}function c(t){return"0x"+t.toString(16)}async function f(t,e=4,r=250){let n=null;for(let a=0;a<e;a++)try{let e=await fetch(b,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok)throw Error("RPC HTTP "+e.status);let r=await e.json();if(Array.isArray(r)){let t=r.find(t=>t&&t.error);if(t)throw Error(t.error?.message||"RPC batch error")}else if(r&&r.error)throw Error(r.error?.message||"RPC error");return r}catch(t){n=t,await function(t){return new Promise(e=>setTimeout(e,t))}(Math.round(r*Math.pow(1.6,a)))}throw n||Error("RPC failed after retries")}async function m(t){let e=await f({jsonrpc:"2.0",id:1,method:"eth_getBlockByNumber",params:[t,!1]}),r=e?.result;if(!r)throw Error("Block not found");return{num:parseInt(r.number,16),ts:parseInt(r.timestamp,16)}}async function g(t){return m(c(t))}async function p(){return m("earliest")}async function h(){return m("latest")}async function d(t){let e=await p(),r=await h();if(t<=e.ts)return e.num;if(t>r.ts)return r.num;let n=e.num,a=r.num;for(;n<a;){let e=n+Math.floor((a-n)/2);(await g(e)).ts>=t?a=e:n=e+1}return n}async function w(t){let e=await p(),r=await h();if(t<e.ts)return e.num;if(t>=r.ts)return r.num;let n=e.num,a=r.num;for(;n<a;){let e=n+Math.floor((a-n+1)/2);(await g(e)).ts<=t?n=e:a=e-1}return n}async function y(t,e){let r=await f({jsonrpc:"2.0",id:1,method:"eth_getLogs",params:[{fromBlock:c(t),toBlock:c(e),address:E,topics:[v]}]});return r?.result||[]}async function P(t,e){let r=function(t,e){let r=[],n=t;for(;n<=e;){let t=Math.min(n+1e5-1,e);r.push({from:n,to:t}),n=t+1}return r}(t,e),n=[];for(let t=0;t<r.length;t+=8){let e=r.slice(t,t+8).map((e,r)=>f({jsonrpc:"2.0",id:1e3+t+r,method:"eth_getLogs",params:[{fromBlock:c(e.from),toBlock:c(e.to),address:E,topics:[v]}]}));for(let t of(await Promise.all(e)))n.push(...t?.result||[])}let a=new Map;for(let t of n){let e=`${t.transactionHash}-${parseInt(t.logIndex,16)}`;a.set(e,t)}return Array.from(a.values())}function S(t){try{let[e,r,n,s,o,i,l,u,c]=new a.Interface(["event GameResultEvent(uint256 gameNumber, string gameId, string startedAt, string winningPlayer, string winningClasses, string losingPlayer, string losingClasses, string gameLength, string endReason)"]).parseLog({topics:t.topics,data:t.data}).args;return{blockNumber:parseInt(t.blockNumber,16),txHash:t.transactionHash,gameNumber:Number(e?.toString?.()??e),gameId:String(r),startedAt:String(n),winningPlayer:String(s),winningClasses:String(o),losingPlayer:String(i),losingClasses:String(l),gameLength:String(u),endReason:String(c)}}catch{return null}}async function _(t,e,r){let n=Math.floor(t/86400),a=await d(t),s=await w(Math.min(Math.max(e,0),r));if(s<a)return{key:n,entry:{fromBlock:a,toBlock:s,rows:[],lastUpdate:Date.now()}};try{let t=(await y(a,s)).map(S).filter(Boolean);return{key:n,entry:{fromBlock:a,toBlock:s,rows:t,lastUpdate:Date.now()}}}catch{let t=(await P(a,s)).map(S).filter(Boolean);return{key:n,entry:{fromBlock:a,toBlock:s,rows:t,lastUpdate:Date.now()}}}}async function k(t,e,r,n){let a=t.toBlock+1,s=await w(Math.min(Math.max(r,0),n));if(s<a)return t;let o=[];try{o=await y(a,s)}catch{o=await P(a,s)}let i=o.map(S).filter(Boolean),l=[...t.rows,...i],u=new Map;for(let t of l)u.set(t.txHash+":"+t.blockNumber,t);return{fromBlock:t.fromBlock,toBlock:s,rows:Array.from(u.values()),lastUpdate:Date.now()}}async function R(t,e){try{let{startTs:r,endTs:n}=t.body||{},a=await p(),s=await h(),i="number"==typeof r&&r>0?r:a.ts,c="number"==typeof n&&n>0?n:s.ts;if(c<i)return e.status(200).json({ok:!0,rows:[]});let f=Math.floor(i/86400),m=Math.floor(c/86400),g=Math.floor(s.ts/86400),d=[];for(let t=f;t<=m;t++){let e=86400*t,r=e+86399;d.push({key:t,start:Math.max(e,i),end:Math.min(r,c)})}let w=[];for(let t=0;t<d.length;t+=6){let e=d.slice(t,t+6).map(async t=>{let e=A.get(t.key);if(e&&t.key<g){w.push(...e.rows);return}if(e&&t.key===g){let r=await k(e,t.start,t.end,s.ts);o(t.key,r),await u(t.key,r),w.push(...r.rows);return}let r=await l(t.key);if(r&&t.key<g){o(t.key,r),w.push(...r.rows);return}if(r&&t.key===g){let e=await k(r,t.start,t.end,s.ts);o(t.key,e),await u(t.key,e),w.push(...e.rows);return}let n=await _(t.start,t.end,s.ts);o(n.key,n.entry),await u(n.key,n.entry),w.push(...n.entry.rows)});await Promise.all(e)}w.sort((t,e)=>t.blockNumber-e.blockNumber),e.status(200).json({ok:!0,rows:w})}catch(t){e.status(200).json({ok:!1,error:t?.message||String(t)})}}new a.Interface(["event GameResultEvent(uint256 gameNumber, string gameId, string startedAt, string winningPlayer, string winningClasses, string losingPlayer, string losingClasses, string gameLength, string endReason)"]),n()}catch(t){n(t)}})},7153:(t,e)=>{var r;Object.defineProperty(e,"x",{enumerable:!0,get:function(){return r}}),function(t){t.PAGES="PAGES",t.PAGES_API="PAGES_API",t.APP_PAGE="APP_PAGE",t.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(t,e,r)=>{t.exports=r(145)}};var e=require("../../webpack-api-runtime.js");e.C(t);var r=e(e.s=8596);module.exports=r})();