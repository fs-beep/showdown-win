"use strict";(()=>{var t={};t.id=48,t.ids=[48],t.modules={145:t=>{t.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},1467:t=>{t.exports=import("@vercel/kv")},8844:t=>{t.exports=import("ethers")},6249:(t,e)=>{Object.defineProperty(e,"l",{enumerable:!0,get:function(){return function t(e,r){return r in e?e[r]:"then"in e&&"function"==typeof e.then?e.then(e=>t(e,r)):"function"==typeof e&&"default"===r?e:void 0}}})},8596:(t,e,r)=>{r.a(t,async(t,a)=>{try{r.r(e),r.d(e,{config:()=>c,default:()=>u,routeModule:()=>f});var n=r(1802),s=r(7153),o=r(6249),i=r(3923),l=t([i]);i=(l.then?(await l)():l)[0];let u=(0,o.l)(i,"default"),c=(0,o.l)(i,"config"),f=new n.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/eth",pathname:"/api/eth",bundlePath:"",filename:""},userland:i});a()}catch(t){a(t)}})},3923:(t,e,r)=>{r.a(t,async(t,a)=>{try{r.r(e),r.d(e,{default:()=>R});var n=r(8844),s=t([n]);n=(s.then?(await s)():s)[0];let N=(process.env.CONTRACT_ADDRESS||"0xae2afe4d192127e6617cfa638a94384b53facec1").toLowerCase(),T="0xccc938abc01344413efee36b5d484cedd3bf4ce93b496e8021ba021fed9e2725",v=new Map,M=[];function o(t,e){for(v.has(t)||M.push(t),v.set(t,e);M.length>120;){let t=M.shift();void 0!==t&&v.delete(t)}}let C=!!(process.env.KV_REST_API_URL||process.env.UPSTASH_REDIS_REST_URL),U=null;async function i(){return C?(!process.env.KV_REST_API_URL&&process.env.UPSTASH_REDIS_REST_URL&&(process.env.KV_REST_API_URL=process.env.UPSTASH_REDIS_REST_URL),!process.env.KV_REST_API_TOKEN&&process.env.UPSTASH_REDIS_REST_TOKEN&&(process.env.KV_REST_API_TOKEN=process.env.UPSTASH_REDIS_REST_TOKEN),U||(U=(await Promise.resolve().then(r.bind(r,1467))).kv),U):null}async function l(t){try{let e=await i();if(!e)return null;return await e.get(`day:${t}`)||null}catch{return null}}function u(t){let e={};for(let r of t){let t=(r.winningClasses||"").trim(),a=(r.losingClasses||"").trim();t&&(e[t]||(e[t]={wins:0,losses:0,total:0}),e[t].wins+=1,e[t].total+=1),a&&(e[a]||(e[a]={wins:0,losses:0,total:0}),e[a].losses+=1,e[a].total+=1)}return{byClass:e,lastUpdate:Date.now()}}async function c(t,e){try{let r=await i();if(!r)return;await r.set(`day:${t}`,e);let a=u(e.rows);await r.set(`dayAgg:${t}`,a)}catch{}}function f(t){return"0x"+t.toString(16)}function m(t){return new Promise(e=>setTimeout(e,t))}async function g(t,e=6,r=800){let a=null;for(let n=0;n<e;n++)try{let e=await fetch("https://6342.rpc.thirdweb.com/",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(429===e.status||503===e.status){a=Error("RPC HTTP "+e.status);let t=Number(e.headers.get("retry-after")),s=t>0?1e3*t:Math.round(r*Math.pow(1.8,n));await m(s);continue}if(!e.ok)throw Error("RPC HTTP "+e.status);let s=await e.json();if(Array.isArray(s)){let t=s.find(t=>t&&t.error);if(t)throw Error(t.error?.message||"RPC batch error")}else if(s&&s.error)throw Error(s.error?.message||"RPC error");return s}catch(t){a=t,await m(Math.round(r*Math.pow(1.6,n)))}throw a||Error("RPC failed after retries")}async function w(t){let e=await g({jsonrpc:"2.0",id:1,method:"eth_getBlockByNumber",params:[t,!1]}),r=e?.result;if(!r)throw Error("Block not found");return{num:parseInt(r.number,16),ts:parseInt(r.timestamp,16)}}async function d(t){return w(f(t))}async function p(){return w("earliest")}async function y(){return w("latest")}async function h(t,e){let r=e?.earliest??await p(),a=e?.latest??await y(),n=Math.max(t,r.ts);if(n<=r.ts)return r.num;if(n>a.ts)return a.num;let s=r.num,o=a.num;for(;s<o;){let t=s+Math.floor((o-s)/2);(await d(t)).ts>=n?o=t:s=t+1}return s}async function b(t,e){let r=e?.earliest??await p(),a=e?.latest??await y(),n=Math.min(t,a.ts);if(n<r.ts)return r.num;if(n>=a.ts)return a.num;let s=r.num,o=a.num;for(;s<o;){let t=s+Math.floor((o-s+1)/2);(await d(t)).ts<=n?s=t:o=t-1}return s}async function P(t,e){let r=await g({jsonrpc:"2.0",id:1,method:"eth_getLogs",params:[{fromBlock:f(t),toBlock:f(e),address:N,topics:[T]}]}),a=r?.result||[],n=new Map;for(let t of a){let e=`${t.transactionHash}-${parseInt(t.logIndex,16)}`;n.set(e,t)}return Array.from(n.values())}async function k(t,e){let r=function(t,e){let r=[],a=t;for(;a<=e;){let t=Math.min(a+1e5-1,e);r.push({from:a,to:t}),a=t+1}return r}(t,e),a=[];for(let t=0;t<r.length;t+=2){let e=r.slice(t,t+2).map((e,r)=>g({jsonrpc:"2.0",id:1e3+t+r,method:"eth_getLogs",params:[{fromBlock:f(e.from),toBlock:f(e.to),address:N,topics:[T]}]}));for(let t of(await Promise.all(e)))a.push(...t?.result||[])}let n=new Map;for(let t of a){let e=`${t.transactionHash}-${parseInt(t.logIndex,16)}`;n.set(e,t)}return Array.from(n.values())}function S(t){try{let[e,r,a,s,o,i,l,u,c]=new n.Interface(["event GameResultEvent(uint256 gameNumber, string gameId, string startedAt, string winningPlayer, string winningClasses, string losingPlayer, string losingClasses, string gameLength, string endReason)"]).parseLog({topics:t.topics,data:t.data}).args;return{blockNumber:parseInt(t.blockNumber,16),txHash:t.transactionHash,logIndex:parseInt(t.logIndex,16),gameNumber:Number(e?.toString?.()??e),gameId:String(r),startedAt:String(a),winningPlayer:String(s),winningClasses:String(o),losingPlayer:String(i),losingClasses:String(l),gameLength:String(u),endReason:String(c)}}catch{return null}}function _(t){return t.map(S).filter(Boolean)}function I(t){let e=new Map;for(let r of t){let t="number"!=typeof r.logIndex||isNaN(r.logIndex)?r.blockNumber:r.logIndex;e.set(`${r.txHash}:${t}`,r)}return Array.from(e.values())}async function A(t,e,r){let a=Math.floor(t/86400),n=Math.max(t,r.earliest.ts),s=Math.min(Math.max(e,0),r.latest.ts),o=await h(n,r),i=await b(s,r);if(i<o)return{key:a,entry:{fromBlock:o,toBlock:i,rows:[],lastUpdate:Date.now()}};try{let t=await P(o,i),e=I(_(t));return{key:a,entry:{fromBlock:o,toBlock:i,rows:e,lastUpdate:Date.now()}}}catch{let t=await k(o,i),e=I(_(t));return{key:a,entry:{fromBlock:o,toBlock:i,rows:e,lastUpdate:Date.now()}}}}async function x(t,e,r,a){let n=t.toBlock+1,s=await b(Math.min(Math.max(r,0),a.latest.ts),a);if(s<n)return t;let o=[];try{o=await P(n,s)}catch{o=await k(n,s)}let i=o.map(S).filter(Boolean),l=[...t.rows,...i],u=new Map;for(let t of l){let e="number"!=typeof t.logIndex||isNaN(t.logIndex)?t.blockNumber:t.logIndex;u.set(`${t.txHash}:${e}`,t)}return{fromBlock:t.fromBlock,toBlock:s,rows:Array.from(u.values()),lastUpdate:Date.now()}}async function E(t,e,r){let a=Math.max(t,r.earliest.ts),n=Math.min(Math.max(e,a),r.latest.ts),s=await h(a,r),o=await b(n,r);if(o<s)return[];let i=[];try{i=await P(s,o)}catch{i=await k(s,o)}let l=I(_(i));return l.sort((t,e)=>t.blockNumber-e.blockNumber),l}async function R(t,e){try{let{startTs:r,endTs:a,rebuildDay:n,wantAgg:s}=t.body||{};if("number"==typeof n&&n>=0){let t=await p(),r=await y(),a=86400*n,s=await A(a,a+86399,{earliest:t,latest:r});return o(s.key,s.entry),await c(s.key,s.entry),e.status(200).json({ok:!0,rebuilt:s.key,fromBlock:s.entry.fromBlock,toBlock:s.entry.toBlock,rows:s.entry.rows.length})}let i=await p(),f=await y(),m={earliest:i,latest:f},g="number"==typeof r&&r>0?r:i.ts,w="number"==typeof a&&a>0?a:f.ts;if(w<g)return e.status(200).json({ok:!0,rows:[]});let d=[];if(C){let t=Math.floor(g/86400),e=Math.floor(w/86400),r=Math.floor(f.ts/86400),a=[];for(let r=t;r<=e;r++){let t=86400*r,e=t+86399;a.push({key:r,start:Math.max(t,g),end:Math.min(e,w)})}for(let t=0;t<a.length;t+=2){let e=a.slice(t,t+2).map(async t=>{let e=v.get(t.key);if(e&&t.key<r){d.push(...e.rows);return}if(e&&t.key===r){let r=await x(e,t.start,t.end,m);o(t.key,r),await c(t.key,r),d.push(...r.rows);return}let a=await l(t.key);if(a&&t.key<r){o(t.key,a),d.push(...a.rows);return}if(a&&t.key===r){let e=await x(a,t.start,t.end,m);o(t.key,e),await c(t.key,e),d.push(...e.rows);return}let n=await A(t.start,t.end,m);o(n.key,n.entry),await c(n.key,n.entry),d.push(...n.entry.rows)});await Promise.all(e)}}else d=await E(g,w,m);let h=d.filter(t=>{let e=function(t){if(!t)return null;let e=/^([0-9]{4})-([0-9]{2})-([0-9]{2})[ T]([0-9]{2}):([0-9]{2}):([0-9]{2})(?:\s*(?:UTC|Z))?$/i.exec(t.trim());if(e){let t=Number(e[1]),r=Number(e[2])-1,a=Number(e[3]),n=Number(e[4]),s=Number(e[5]),o=Number(e[6]),i=Date.UTC(t,r,a,n,s,o);return Math.floor(i/1e3)}let r=t.replace(" ","T").replace(/\s*UTC$/i,"Z"),a=Date.parse(r);return isNaN(a)?null:Math.floor(a/1e3)}(t.startedAt);return null==e||e>=g&&e<=w}),b=new Map;for(let t of h)b.set("number"!=typeof t.logIndex||isNaN(t.logIndex)?t.gameId?`gid:${t.gameId}`:`${t.txHash}:${t.blockNumber}`:`${t.txHash}:${t.logIndex}`,t);let P=Array.from(b.values());if(P.sort((t,e)=>t.blockNumber-e.blockNumber),s){let t=u(P);return e.status(200).json({ok:!0,rows:P,aggByClass:t.byClass,aggLastUpdate:t.lastUpdate})}e.status(200).json({ok:!0,rows:P})}catch(t){e.status(200).json({ok:!1,error:t?.message||String(t)})}}new n.Interface(["event GameResultEvent(uint256 gameNumber, string gameId, string startedAt, string winningPlayer, string winningClasses, string losingPlayer, string losingClasses, string gameLength, string endReason)"]),a()}catch(t){a(t)}})},7153:(t,e)=>{var r;Object.defineProperty(e,"x",{enumerable:!0,get:function(){return r}}),function(t){t.PAGES="PAGES",t.PAGES_API="PAGES_API",t.APP_PAGE="APP_PAGE",t.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(t,e,r)=>{t.exports=r(145)}};var e=require("../../webpack-api-runtime.js");e.C(t);var r=e(e.s=8596);module.exports=r})();