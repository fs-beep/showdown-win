"use strict";(()=>{var t={};t.id=48,t.ids=[48],t.modules={145:t=>{t.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},1467:t=>{t.exports=import("@vercel/kv")},8844:t=>{t.exports=import("ethers")},9796:t=>{t.exports=require("zlib")},6249:(t,e)=>{Object.defineProperty(e,"l",{enumerable:!0,get:function(){return function t(e,r){return r in e?e[r]:"then"in e&&"function"==typeof e.then?e.then(e=>t(e,r)):"function"==typeof e&&"default"===r?e:void 0}}})},8596:(t,e,r)=>{r.a(t,async(t,a)=>{try{r.r(e),r.d(e,{config:()=>u,default:()=>c,routeModule:()=>f});var n=r(1802),o=r(7153),s=r(6249),l=r(3923),i=t([l]);l=(i.then?(await i)():i)[0];let c=(0,s.l)(l,"default"),u=(0,s.l)(l,"config"),f=new n.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/eth",pathname:"/api/eth",bundlePath:"",filename:""},userland:l});a()}catch(t){a(t)}})},3923:(t,e,r)=>{r.a(t,async(t,a)=>{try{r.r(e),r.d(e,{default:()=>O});var n=r(8844),o=r(9796),s=t([n]);n=(s.then?(await s)():s)[0];let G=process.env.RPC_URL||"https://carrot.megaeth.com/rpc",j=process.env.GAME_RESULTS_RPC_URL||process.env.MAINNET_RPC_URL||"https://mainnet.megaeth.com/rpc?vip=1&u=ShowdownV2&v=5184000&s=mafia&verify=1768480681-D2QvAT3JRTgLzi6xznmLd6ZeCHypjBf34gkTQ9HD8mM%3D",K=(process.env.CONTRACT_ADDRESS||"0x86b6f3856f086cd29462985f7bbff0d55d2b5d53").toLowerCase(),V="0xae2afe4d192127e6617cfa638a94384b53facec1",q=(process.env.GAME_RESULTS_CONTRACT||process.env.MAINNET_CONTRACT||"0x8aaf217a7a1534327234bd09474fc358e6e4d322").toLowerCase(),z="0xccc938abc01344413efee36b5d484cedd3bf4ce93b496e8021ba021fed9e2725",Z="0x95340ecf2fd1c1da827f4cf010d0726c65c2e05684a492c4eeaa6ac1b91babf0",F=Math.floor(new Date("2025-11-15T00:00:00Z").getTime()/1e3),J=Math.floor(new Date("2026-01-15T11:49:24Z").getTime()/1e3),Q=(process.env.CACHE_NAMESPACE||`${K}:${Z}`).toLowerCase();function l(t){return`${Q}:${t}`}let W=new Map,X=[];function i(t,e){let r=l(t);for(W.has(r)||X.push(r),W.set(r,e);X.length>120;){let t=X.shift();void 0!==t&&W.delete(t)}}let Y=!!(process.env.KV_REST_API_URL||process.env.UPSTASH_REDIS_REST_URL);function c(t){return`${Q}:day:${t}`}let tt=null;async function u(){return Y?(!process.env.KV_REST_API_URL&&process.env.UPSTASH_REDIS_REST_URL&&(process.env.KV_REST_API_URL=process.env.UPSTASH_REDIS_REST_URL),!process.env.KV_REST_API_TOKEN&&process.env.UPSTASH_REDIS_REST_TOKEN&&(process.env.KV_REST_API_TOKEN=process.env.UPSTASH_REDIS_REST_TOKEN),tt||(tt=(await Promise.resolve().then(r.bind(r,1467))).kv),tt):null}async function f(t){try{let e=await u();if(!e)return null;if(86400*t>=F)return await e.get(c(t));{let[r,a]=await Promise.all([e.get(c(t)),e.get(`day:${t}`)]);return r||a}}catch{return null}}function g(t){let e={};for(let r of t){let t=(r.winningClasses||"").trim(),a=(r.losingClasses||"").trim();t&&(e[t]||(e[t]={wins:0,losses:0,total:0}),e[t].wins+=1,e[t].total+=1),a&&(e[a]||(e[a]={wins:0,losses:0,total:0}),e[a].losses+=1,e[a].total+=1)}return{byClass:e,lastUpdate:Date.now()}}async function m(t,e){try{let r=await u();if(!r)return;await r.set(c(t),e);let a=g(e.rows);await r.set(`${Q}:dayAgg:${t}`,a)}catch{}}let te=new n.Interface(["event GameResultEvent(uint256 gameNumber, string gameId, string startedAt, string winningPlayer, string winningClasses, string losingPlayer, string losingClasses, string gameLength, string endReason, string gameType, string metadata)"]),tr=new n.Interface(["event GameResultEvent(uint256 gameNumber, string gameId, string startedAt, string winningPlayer, string winningClasses, string losingPlayer, string losingClasses, string gameLength, string endReason)"]);function h(t){return"0x"+t.toString(16)}function w(t){return new Promise(e=>setTimeout(e,t))}function d(t){let e=(t||"").trim(),r=e.indexOf("#");return -1===r?e:e.slice(0,r)}function p(t,e,r){let a=JSON.stringify(r),n=(0,o.gzipSync)(a);t.setHeader("Content-Type","application/json"),t.setHeader("Content-Encoding","gzip"),t.status(e).send(n)}async function y(t,e=G,r=6,a=800){let n=null;for(let o=0;o<r;o++)try{let r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(429===r.status||503===r.status){n=Error("RPC HTTP "+r.status);let t=Number(r.headers.get("retry-after")),e=t>0?1e3*t:Math.round(a*Math.pow(1.8,o));await w(e);continue}if(!r.ok)throw Error("RPC HTTP "+r.status);let s=await r.json();if(Array.isArray(s)){let t=s.find(t=>t&&t.error);if(t)throw Error(t.error?.message||"RPC batch error")}else if(s&&s.error)throw Error(s.error?.message||"RPC error");return s}catch(t){n=t,await w(Math.round(a*Math.pow(1.6,o)))}throw n||Error("RPC failed after retries")}async function b(t,e=G){let r=await y({jsonrpc:"2.0",id:1,method:"eth_getBlockByNumber",params:[t,!1]},e),a=r?.result;if(!a)throw Error("Block not found");return{num:parseInt(a.number,16),ts:parseInt(a.timestamp,16)}}async function k(t,e=G){return b(h(t),e)}async function M(t=G){return b("earliest",t)}async function S(t=G){return b("latest",t)}async function x(t,e,r=G){let a=e?.earliest??await M(r),n=e?.latest??await S(r),o=Math.max(t,a.ts);if(o<=a.ts)return a.num;if(o>n.ts)return n.num;let s=a.num,l=n.num;for(;s<l;){let t=s+Math.floor((l-s)/2);(await k(t,r)).ts>=o?l=t:s=t+1}return s}async function P(t,e,r=G){let a=e?.earliest??await M(r),n=e?.latest??await S(r),o=Math.min(t,n.ts);if(o<a.ts)return a.num;if(o>=n.ts)return n.num;let s=a.num,l=n.num;for(;s<l;){let t=s+Math.floor((l-s+1)/2);(await k(t,r)).ts<=o?s=t:l=t-1}return s}async function A(t,e,r=K,a=Z,n=G){if(e-t+1>1e5)throw Error(`Block range ${e-t+1} exceeds MAX_SPAN 100000`);let o=await y({jsonrpc:"2.0",id:1,method:"eth_getLogs",params:[{fromBlock:h(t),toBlock:h(e),address:r,topics:[a]}]},n);if(o?.error)throw Error(o.error.message||"RPC error");let s=o?.result||[],l=new Map;for(let t of s){let e=`${t.transactionHash}-${parseInt(t.logIndex,16)}`;l.set(e,t)}return Array.from(l.values())}async function R(t,e,r=K,a=Z,n=G){let o=function(t,e){let r=[],a=t;for(;a<=e;){let t=Math.min(a+1e5-1,e);r.push({from:a,to:t}),a=t+1}return r}(t,e),s=[];for(let t=0;t<o.length;t+=3){let e=o.slice(t,t+3).map((e,o)=>y({jsonrpc:"2.0",id:1e3+t+o,method:"eth_getLogs",params:[{fromBlock:h(e.from),toBlock:h(e.to),address:r,topics:[a]}]},n));for(let t of(await Promise.all(e))){if(t?.error){console.error("getLogsChunked chunk error:",t.error);continue}s.push(...t?.result||[])}}let l=new Map;for(let t of s){let e=`${t.transactionHash}-${parseInt(t.logIndex,16)}`;l.set(e,t)}return Array.from(l.values())}function N(t){try{let[e,r,a,n,o,s,l,i,c,u,f]=te.parseLog({topics:t.topics,data:t.data}).args;return{blockNumber:parseInt(t.blockNumber,16),txHash:t.transactionHash,logIndex:parseInt(t.logIndex,16),gameNumber:Number(e?.toString?.()??e),gameId:String(r),startedAt:String(a),winningPlayer:d(String(n)),winningClasses:String(o),losingPlayer:d(String(s)),losingClasses:String(l),gameLength:String(i),endReason:String(c),gameType:null!=u?String(u):void 0,metadata:null!=f?String(f):void 0,network:"megaeth-testnet-v2"}}catch{return null}}function T(t){try{let[e,r,a,n,o,s,l,i,c]=tr.parseLog({topics:t.topics,data:t.data}).args;return{blockNumber:parseInt(t.blockNumber,16),txHash:t.transactionHash,logIndex:parseInt(t.logIndex,16),gameNumber:Number(e?.toString?.()??e),gameId:String(r),startedAt:String(a),winningPlayer:d(String(n)),winningClasses:String(o),losingPlayer:d(String(s)),losingClasses:String(l),gameLength:String(i),endReason:String(c),network:"legacy"}}catch{return null}}function v(t,e=!1){return t.map(e?T:N).filter(Boolean)}function _(t){let e=new Map;for(let r of t){let t="number"!=typeof r.logIndex||isNaN(r.logIndex)?r.blockNumber:r.logIndex;e.set(`${r.txHash}:${t}`,r)}return Array.from(e.values())}function I(t,e){let r=new Map;for(let e of t)r.set(L(e),e);for(let t of e)r.set(L(t),t);return Array.from(r.values())}function E(t){return!!t?.rows?.some(t=>"megaeth-testnet-v2"===t.network)}function C(t){if(!t)return null;let e=/^([0-9]{4})-([0-9]{2})-([0-9]{2})[ T]([0-9]{2}):([0-9]{2}):([0-9]{2})(?:\s*(?:UTC|Z))?$/i.exec(t.trim());if(e){let t=Number(e[1]),r=Number(e[2])-1,a=Number(e[3]),n=Number(e[4]),o=Number(e[5]),s=Number(e[6]),l=Date.UTC(t,r,a,n,o,s);return Math.floor(l/1e3)}let r=t.replace(" ","T").replace(/\s*UTC$/i,"Z"),a=Date.parse(r);return isNaN(a)?null:Math.floor(a/1e3)}function U(t,e){let r=C(t.startedAt),a=C(e.startedAt);return null!==r&&null!==a?a-r:null!==r?-1:null!==a?1:e.blockNumber-t.blockNumber}function L(t){return"number"!=typeof t.logIndex||isNaN(t.logIndex)?t.gameId?`gid:${t.gameId}`:`${t.txHash}:${t.blockNumber}`:`${t.txHash}:${t.logIndex}`}async function $(t,e,r){let a=Math.floor(t/86400),n=Math.max(t,r.earliest.ts),o=Math.min(Math.max(e,0),r.latest.ts),s=await x(n,r),l=await P(o,r);if(l<s)return{key:a,entry:{fromBlock:s,toBlock:l,rows:[],lastUpdate:Date.now()}};let i=t<F,c=i?V:K,u=i?z:Z;if(t>=F&&c!==K){let t=await R(s,l,K,Z),e=_(v(t,!1));return{key:a,entry:{fromBlock:s,toBlock:l,rows:e,lastUpdate:Date.now()}}}try{let t=await A(s,l,c,u),e=_(v(t,i));return{key:a,entry:{fromBlock:s,toBlock:l,rows:e,lastUpdate:Date.now()}}}catch{let t=await R(s,l,c,u),e=_(v(t,i));return{key:a,entry:{fromBlock:s,toBlock:l,rows:e,lastUpdate:Date.now()}}}}async function B(t,e,r,a){let n=t.toBlock+1,o=await P(Math.min(Math.max(r,0),a.latest.ts),a);if(o<n)return t;let s=[];try{s=await A(n,o)}catch{s=await R(n,o)}let l=s.map(N).filter(Boolean),i=[...t.rows,...l],c=new Map;for(let t of i){let e="number"!=typeof t.logIndex||isNaN(t.logIndex)?t.blockNumber:t.logIndex;c.set(`${t.txHash}:${e}`,t)}return{fromBlock:t.fromBlock,toBlock:o,rows:Array.from(c.values()),lastUpdate:Date.now()}}async function D(t,e,r){let a;let n=Math.max(t,r.earliest.ts),o=Math.min(Math.max(e,n),r.latest.ts);if(o<n)return[];let s=n<F,l=o>=F,i=[];if(s){let t=await x(n,r),e=await P(Math.min(o,F-1),r);e>=t&&i.push((async()=>{try{let r=await A(t,e,V,z);return _(v(r,!0))}catch{let r=await R(t,e,V,z);return _(v(r,!0))}})())}if(l){let t=await x(Math.max(n,F),r),e=await P(o,r);e>=t&&i.push((async()=>{try{if("0x86b6f3856f086cd29462985f7bbff0d55d2b5d53"!==K)throw Error(`Wrong contract address: ${K}`);let r=await A(t,e,K,Z),a=v(r,!1),n=_(a);return 0===n.length&&r.length>0&&console.error("Decoded logs but got 0 rows",{logsLength:r.length,fromBlock:t,toBlock:e}),n}catch(r){console.error("getLogsSingle failed, trying chunked",{error:r?.message||String(r),fromBlock:t,toBlock:e,contract:K,topic0:Z});try{let r=await R(t,e,K,Z),a=v(r,!1);return _(a)}catch(r){return console.error("getLogsChunked also failed",{error:r?.message||String(r),fromBlock:t,toBlock:e}),[]}}})())}if(0===i.length)return console.error("fetchRangeRowsDirect: No queries to execute",{startTs:t,endTs:e,needsLegacy:s,needsNew:l}),[];try{a=await Promise.all(i)}catch(r){return console.error("fetchRangeRowsDirect: Promise.all failed",{error:r?.message||String(r),startTs:t,endTs:e,queriesCount:i.length}),[]}let c=[];for(let t of a)Array.isArray(t)?c=I(c,t):console.error("fetchRangeRowsDirect: Invalid rows result",{rows:t});return c.sort(U),0===c.length&&e>=F&&console.error("fetchRangeRowsDirect: Got 0 rows for new contract range",{startTs:t,endTs:e,needsNew:l,queriesCount:i.length,resultsLengths:a.map(t=>Array.isArray(t)?t.length:"invalid")}),c}async function H(t,e){let r=await M(j),a=await S(j),n={earliest:r,latest:a},o=Math.max(t,r.ts),s=Math.min(e,a.ts);if(s<o)return[];let l=await x(o,n,j),i=await P(s,n,j);if(i<l)return[];let c=[];try{c=await A(l,i,q,Z,j)}catch{c=await R(l,i,q,Z,j)}return _(v(c,!1)).map(t=>({...t,network:"megaeth-mainnet"})).sort(U)}async function O(t,e){try{var r,a;let{startTs:n,endTs:o,rebuildDay:s,wantAgg:h,clearCache:w}=t.body||{};if("number"==typeof s&&s>=0){let t=await M(),r=await S(),a=86400*s,n=await $(a,a+86399,{earliest:t,latest:r});return i(n.key,n.entry),await m(n.key,n.entry),p(e,200,{ok:!0,rebuilt:n.key,fromBlock:n.entry.fromBlock,toBlock:n.entry.toBlock,rows:n.entry.rows.length})}let d=await M(),y=await S(),b={earliest:d,latest:y},k="number"==typeof n&&n>0?n:d.ts,T="number"==typeof o&&o>0?o:y.ts;if(!("number"==typeof o&&o>0))try{let t=await S(j);T=Math.max(T,t.ts)}catch{}if(T<k)return p(e,200,{ok:!0,rows:[]});let v=[],_=Math.min(T,J),O=T>J;if(w){console.log("Clearing cache and fetching fresh data",{sTs:k,eTs:T});let t=Math.floor(k/86400),e=Math.floor(T/86400);for(let r=t;r<=e;r++){let t=l(r);W.delete(t);try{let t=await u();t&&await t.del(c(r))}catch(t){console.error("Failed to clear KV cache for day",r,t)}}_>=k&&(v=await D(k,_,b));let r=new Map;for(let t of v){let e=C(t.startedAt);if(e){let a=Math.floor(e/86400);r.has(a)||r.set(a,[]),r.get(a).push(t)}}for(let[t,e]of r){let r={fromBlock:Math.min(...e.map(t=>t.blockNumber)),toBlock:Math.max(...e.map(t=>t.blockNumber)),rows:e.sort(U),lastUpdate:Date.now()};i(t,r),await m(t,r)}}else if(Y){let t=Math.min(_,F-1),e=Math.max(k,F);if(_>=k&&k<F&&t>=k){let e=Math.floor(k/86400),r=Math.floor(t/86400),a=Math.floor(y.ts/86400),n=Math.floor(F/86400),o=[];for(let a=e;a<=r;a++){if(a>=n)continue;let e=86400*a,r=e+86399;o.push({key:a,start:Math.max(e,k),end:Math.min(r,t)})}for(let t=0;t<o.length;t+=10){let e=o.slice(t,t+10).map(async t=>{let e=t.key<a,r=86400*t.key,n=r+86399,o=r>=F,s=o?r:t.start,c=o?n:t.end;if(o&&e){let e=W.get(l(t.key));if(e&&E(e)&&e.rows.length>0){v.push(...e.rows);return}let r=await f(t.key);if(r&&E(r)&&r.rows.length>0){i(t.key,r),v.push(...r.rows);return}let a=await x(s,b),n=await P(c,b);if(n<a)return;let o=[];try{o=await A(a,n)}catch{o=await R(a,n)}let u=o.map(N).filter(Boolean),g=new Map;for(let t of u){let e="number"!=typeof t.logIndex||isNaN(t.logIndex)?t.blockNumber:t.logIndex;g.set(`${t.txHash}:${e}`,t)}let h=Array.from(g.values()),w={fromBlock:a,toBlock:n,rows:h,lastUpdate:Date.now()};h.length>0&&(i(t.key,w),await m(t.key,w)),v.push(...h);return}let u=W.get(l(t.key));if(u){if(e){v.push(...u.rows);return}{let e=await B(u,t.start,t.end,b);i(t.key,e),await m(t.key,e),v.push(...e.rows);return}}let g=await f(t.key);if(g){if(e){i(t.key,g),v.push(...g.rows);return}{let e=await B(g,t.start,t.end,b);i(t.key,e),await m(t.key,e),v.push(...e.rows);return}}let h=await $(s,c,b);i(h.key,h.entry),await m(h.key,h.entry),v.push(...h.entry.rows)});await Promise.all(e)}}if(_>=F){let t=Math.floor(y.ts/86400),r=Math.min(_,86400*t-1);if(r>=e){let t=Math.floor(e/86400),a=Math.floor(r/86400),n=Math.min(5,a-t+1);for(let o=0;o<=a-t;o+=n){let s=[];for(let c=0;c<n&&t+o+c<=a;c++){let a=t+o+c,n=86400*a,u=n+86399,g=Math.max(n,e),h=Math.min(u,r);s.push((async()=>{let t=W.get(l(a));if(t&&E(t)&&t.rows.length>0)return t.rows;let e=await f(a);if(e&&E(e)&&e.rows.length>0)return i(a,e),e.rows;try{let t=await D(g,h,b);if(t.length>0){let e,r;e=Math.min(...t.map(t=>t.blockNumber)),r=Math.max(...t.map(t=>t.blockNumber));let n={fromBlock:e,toBlock:r,rows:t,lastUpdate:Date.now()};i(a,n),await m(a,n)}return t}catch(t){return console.error(`Failed to fetch day ${a}`,{error:t?.message||String(t),dayStart:g,dayEnd:h}),[]}})())}for(let t of(await Promise.all(s)))v=I(v,t)}}}}else console.log("Fetching directly without cache (no KV)",{sTs:k,eTs:T}),_>=k&&(v=await D(k,_,b));if(_>=k){let t=Math.floor(y.ts/86400);if(Math.floor(_/86400)>=t){let e=Math.max(k,86400*t);if(e<=_){let t=await D(e,_,b);v=I(v,t)}}}if(O){let t=await H(Math.max(k,J+1),T);v=I(v,t)}v.sort(U);let G=(r=v,a=T,r.filter(t=>{let e=C(t.startedAt);return null==e||e>=k&&e<=a})),K=new Map;for(let t of G)K.set(L(t),t);let V=Array.from(K.values());if(V.sort(U),h){let t=g(V);return p(e,200,{ok:!0,rows:V,aggByClass:t.byClass,aggLastUpdate:t.lastUpdate})}p(e,200,{ok:!0,rows:V})}catch(t){p(e,200,{ok:!1,error:t?.message||String(t)})}}a()}catch(t){a(t)}})},7153:(t,e)=>{var r;Object.defineProperty(e,"x",{enumerable:!0,get:function(){return r}}),function(t){t.PAGES="PAGES",t.PAGES_API="PAGES_API",t.APP_PAGE="APP_PAGE",t.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(t,e,r)=>{t.exports=r(145)}};var e=require("../../webpack-api-runtime.js");e.C(t);var r=e(e.s=8596);module.exports=r})();