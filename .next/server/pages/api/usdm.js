"use strict";(()=>{var t={};t.id=462,t.ids=[462],t.modules={145:t=>{t.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},1467:t=>{t.exports=import("@vercel/kv")},6249:(t,e)=>{Object.defineProperty(e,"l",{enumerable:!0,get:function(){return function t(e,o){return o in e?e[o]:"then"in e&&"function"==typeof e.then?e.then(e=>t(e,o)):"function"==typeof e&&"default"===o?e:void 0}}})},3847:(t,e,o)=>{o.a(t,async(t,r)=>{try{o.r(e),o.d(e,{config:()=>u,default:()=>c,routeModule:()=>f});var a=o(1802),s=o(7153),l=o(6249),n=o(2466),i=t([n]);n=(i.then?(await i)():i)[0];let c=(0,l.l)(n,"default"),u=(0,l.l)(n,"config"),f=new a.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/usdm",pathname:"/api/usdm",bundlePath:"",filename:""},userland:n});r()}catch(t){r(t)}})},2466:(t,e,o)=>{o.a(t,async(t,r)=>{try{o.r(e),o.d(e,{default:()=>h});var a=o(1467),s=t([a]);a=(s.then?(await s)():s)[0];let g="0x7b8df4195eda5b193304eecb5107de18b6557d24",w="0xfafddbb3fc7688494971a79cc65dca3ef82079e7",k=[process.env.GAME_RESULTS_RPC_URL,process.env.MAINNET_RPC_URL,"https://mainnet.megaeth.com/rpc"].filter(Boolean),y="0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",B=0,b="usdm:state:v10",v="usdm:cache:v10",P=null;function l(){return Date.now()}function n(t){return"0x"+t.toString(16)}function i(t){return t?"0x"+t.slice(-40).toLowerCase():""}async function c(t){let e=null;for(let o=0;o<k.length;o++){let r=k[(B+o)%k.length];for(let a=0;a<5;a+=1)try{let s=new AbortController,l=setTimeout(()=>s.abort(),15e3),n=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),signal:s.signal});if(clearTimeout(l),429===n.status||502===n.status||503===n.status||504===n.status){e=Error(`RPC HTTP ${n.status}`);let t=2e3*Math.pow(2,a)+1e3*Math.random();await new Promise(e=>setTimeout(e,t));continue}if(!n.ok)throw Error(`RPC HTTP ${n.status}`);let i=await n.json();if(Array.isArray(i)){let t=i.find(t=>t?.error);if(t){let o=t.error?.message||"RPC batch error";if(o.toLowerCase().includes("upstream")||o.toLowerCase().includes("timeout")){e=Error(o);break}throw Error(o)}}else if(i?.error){let t=i.error?.message||"RPC error";if(t.toLowerCase().includes("upstream")||t.toLowerCase().includes("timeout")){e=Error(t);break}throw Error(t)}return B=(B+o)%k.length,i}catch(t){if(e=t,t?.name==="AbortError")break;await new Promise(t=>setTimeout(t,2e3+1e3*Math.random()))}}throw e||Error("All RPCs failed")}async function u(){let t=await c({jsonrpc:"2.0",id:1,method:"eth_getBlockByNumber",params:["latest",!1]});if(!t?.result)throw Error("Block not found");return{num:parseInt(t.result.number,16),ts:parseInt(t.result.timestamp,16)}}async function f(t,e){let o=function(t,e){let o=[],r=t;for(;r<=e;){let t=Math.min(r+5e3-1,e);o.push({from:r,to:t}),r=t+1}return o}(t,e),r="0x"+g.toLowerCase().replace(/^0x/,"").padStart(64,"0"),a=[];for(let t=0;t<o.length;t+=1){let e=o.slice(t,t+1).flatMap((e,o)=>[c({jsonrpc:"2.0",id:1e3+t+2*o,method:"eth_getLogs",params:[{fromBlock:n(e.from),toBlock:n(e.to),address:w,topics:[y,r]}]}),c({jsonrpc:"2.0",id:1e3+t+2*o+1,method:"eth_getLogs",params:[{fromBlock:n(e.from),toBlock:n(e.to),address:w,topics:[y,null,r]}]})]),s=await Promise.all(e),l=new Set;for(let t of s)for(let e of t?.result||[]){let t=`${e.transactionHash}:${e.logIndex}`;l.has(t)||(l.add(t),a.push(e))}await new Promise(t=>setTimeout(t,500))}return a}async function m(t){if(0===t.length)return new Map;let e=t.map((t,e)=>({jsonrpc:"2.0",id:e+1,method:"eth_getBlockByNumber",params:[n(t),!1]})),o=[];for(let t=0;t<e.length;t+=400){let r=e.slice(t,t+400),a=await c(r);o.push(...a),await new Promise(t=>setTimeout(t,200))}let r=new Map;for(let t of o)t?.result&&r.set(parseInt(t.result.number,16),parseInt(t.result.timestamp,16));return r}function d(t,e,o){for(let r of e){let e=i(r.topics?.[1]),a=i(r.topics?.[2]);if(e!==g&&a!==g)continue;let s=BigInt(r.data||"0x0");if(0n===s)continue;let l=o.get(parseInt(r.blockNumber,16))||0;if(l>0){let e=new Date(1e3*l),o=`${e.getUTCFullYear()}-${String(e.getUTCMonth()+1).padStart(2,"0")}-${String(e.getUTCDate()).padStart(2,"0")}`;t.volumeByDay[o]=(BigInt(t.volumeByDay[o]||"0")+s).toString(),t.totalVolume=(BigInt(t.totalVolume||"0")+s).toString()}if(e===g){let e=t.totals[a]||{won:"0",lost:"0",txs:0};e.won=(BigInt(e.won)+s).toString(),e.txs+=1,t.totals[a]=e}else{let o=t.totals[e]||{won:"0",lost:"0",txs:0};o.lost=(BigInt(o.lost)+s).toString(),o.txs+=1,t.totals[e]=o}}}function p(t,e,o){let r=Object.entries(t.totals).map(([t,e])=>({player:t,won:e.won,lost:e.lost,net:(BigInt(e.won)-BigInt(e.lost)).toString(),txs:e.txs}));r.sort((t,e)=>{let o=BigInt(t.net),r=BigInt(e.net);return o===r?e.txs-t.txs:o>r?-1:1});let a=Object.entries(t.volumeByDay).sort((t,e)=>t[0].localeCompare(e[0])).map(([t,e])=>({day:t,volume:e})),s=o&&o>0?l():e||l();return{rows:r.slice(0,10),volumeSeries:a,totalVolume:t.totalVolume||"0",lastBlock:t.lastBlock,updatedAt:s}}async function h(t,e){let o=!!(process.env.KV_REST_API_URL||process.env.UPSTASH_REDIS_REST_URL);if("POST"===t.method)try{let{logs:r,toBlock:s}=t.body;if(!r||!Array.isArray(r)||!s)return e.status(400).json({ok:!1,error:"Missing logs or toBlock"});let l=null;if(o)try{l=await a.kv.get(b)}catch{}if(l||(l={lastBlock:0,totals:{},volumeByDay:{},totalVolume:"0"}),s<=l.lastBlock)return e.status(200).json({ok:!0,skipped:!0,message:"Server already has newer data"});let n=[...new Set(r.map(t=>parseInt(t.blockNumber,16)))],i=new Map;try{i=await m(n)}catch(e){let t=Math.floor(Date.now()/1e3);for(let e of n)i.set(e,t)}if(d(l,r,i),l.lastBlock=s,o)try{await a.kv.set(b,l)}catch(t){console.error("Failed to save client sync state:",t)}let c=p(l,void 0,r.length);if(P=c,o)try{await a.kv.set(v,c)}catch(t){console.error("Failed to save client sync cache:",t)}return e.status(200).json({ok:!0,saved:!0,totalVolume:l.totalVolume,lastBlock:l.lastBlock})}catch(t){return e.status(500).json({ok:!1,error:t?.message||"Server error"})}if(t.query?.fresh!=="1"){if(P)return e.status(200).json({ok:!0,...P,source:"memory"});if(o)try{let t=await a.kv.get(v);if(t)return P=t,e.status(200).json({ok:!0,...t,source:"kv"})}catch{}}let r=null;if(o)try{r=await a.kv.get(b)}catch(t){t?.message}r||(r={lastBlock:0,totals:{},volumeByDay:{},totalVolume:"0"});try{let t=await u();r.lastBlock>t.num&&(console.warn(`USDM state lastBlock ${r.lastBlock} > latest ${t.num}, resetting`),r={lastBlock:0,totals:{},volumeByDay:{},totalVolume:"0"});let s=r.lastBlock>0?r.lastBlock+1:5721028,l=t.num,n=Math.min(s+5e4-1,l),i=n<l,c=n-s+1,h=0;if(s<=n){let t=await f(s,n);if(h=t.length,t.length>0){let e=[...new Set(t.map(t=>parseInt(t.blockNumber,16)))],o=await m(e);d(r,t,o)}if(r.lastBlock=n,o)try{await a.kv.set(b,r)}catch(t){console.error("Failed to save USDM state:",t)}}let g=P?.updatedAt,w=p(r,g,h);if(P=w,o)try{await a.kv.set(v,w)}catch(t){console.error("Failed to save USDM cache:",t)}return e.status(200).json({ok:!0,...w,source:"fresh",needsMoreSync:i,syncedTo:n,latestBlock:l,debug:{fromBlock:s,toBlock:n,blocksToScan:c,logsFound:h,stateLastBlock:r.lastBlock,totalVolume:r.totalVolume}})}catch(l){let t=l?.message||String(l);if(console.error("USDM sync error:",t),P)return e.status(200).json({ok:!0,...P,warning:t,source:"memory-fallback"});if(o)try{let o=await a.kv.get(v);if(o)return P=o,e.status(200).json({ok:!0,...o,warning:t,source:"kv-fallback"})}catch{}let s=p(r,void 0,0);return e.status(200).json({ok:!0,...s,warning:t,source:"state-fallback"})}}r()}catch(t){r(t)}})},7153:(t,e)=>{var o;Object.defineProperty(e,"x",{enumerable:!0,get:function(){return o}}),function(t){t.PAGES="PAGES",t.PAGES_API="PAGES_API",t.APP_PAGE="APP_PAGE",t.APP_ROUTE="APP_ROUTE"}(o||(o={}))},1802:(t,e,o)=>{t.exports=o(145)}};var e=require("../../webpack-api-runtime.js");e.C(t);var o=e(e.s=3847);module.exports=o})();