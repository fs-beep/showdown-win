"use strict";(()=>{var t={};t.id=462,t.ids=[462],t.modules={145:t=>{t.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},1467:t=>{t.exports=import("@vercel/kv")},6249:(t,e)=>{Object.defineProperty(e,"l",{enumerable:!0,get:function(){return function t(e,a){return a in e?e[a]:"then"in e&&"function"==typeof e.then?e.then(e=>t(e,a)):"function"==typeof e&&"default"===a?e:void 0}}})},3847:(t,e,a)=>{a.a(t,async(t,o)=>{try{a.r(e),a.d(e,{config:()=>u,default:()=>c,routeModule:()=>m});var r=a(1802),s=a(7153),l=a(6249),n=a(2466),i=t([n]);n=(i.then?(await i)():i)[0];let c=(0,l.l)(n,"default"),u=(0,l.l)(n,"config"),m=new r.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/usdm",pathname:"/api/usdm",bundlePath:"",filename:""},userland:n});o()}catch(t){o(t)}})},2466:(t,e,a)=>{a.a(t,async(t,o)=>{try{a.r(e),a.d(e,{default:()=>w});var r=a(1467),s=t([r]);r=(s.then?(await s)():s)[0];let h="0x7b8df4195eda5b193304eecb5107de18b6557d24",k="0xfafddbb3fc7688494971a79cc65dca3ef82079e7",B=[process.env.GAME_RESULTS_RPC_URL,process.env.MAINNET_RPC_URL,"https://mainnet.megaeth.com/rpc"].filter(Boolean),b="0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",S=0,v="usdm:state:v13",P="usdm:cache:v13",x=null;function l(){return Date.now()}function n(t){return"0x"+t.toString(16)}function i(t){return t?"0x"+t.slice(-40).toLowerCase():""}async function c(t){let e=null;for(let a=0;a<B.length;a++){let o=B[(S+a)%B.length];for(let r=0;r<5;r+=1)try{let s=new AbortController,l=setTimeout(()=>s.abort(),15e3),n=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),signal:s.signal});if(clearTimeout(l),429===n.status||502===n.status||503===n.status||504===n.status){e=Error(`RPC HTTP ${n.status}`);let t=2e3*Math.pow(2,r)+1e3*Math.random();await new Promise(e=>setTimeout(e,t));continue}if(!n.ok)throw Error(`RPC HTTP ${n.status}`);let i=await n.json();if(Array.isArray(i)){let t=i.find(t=>t?.error);if(t){let a=t.error?.message||"RPC batch error";if(a.toLowerCase().includes("upstream")||a.toLowerCase().includes("timeout")){e=Error(a);break}throw Error(a)}}else if(i?.error){let t=i.error?.message||"RPC error";if(t.toLowerCase().includes("upstream")||t.toLowerCase().includes("timeout")){e=Error(t);break}throw Error(t)}return S=(S+a)%B.length,i}catch(t){if(e=t,t?.name==="AbortError")break;await new Promise(t=>setTimeout(t,2e3+1e3*Math.random()))}}throw e||Error("All RPCs failed")}async function u(){let t=await c({jsonrpc:"2.0",id:1,method:"eth_getBlockByNumber",params:["latest",!1]});if(!t?.result)throw Error("Block not found");return{num:parseInt(t.result.number,16),ts:parseInt(t.result.timestamp,16)}}async function m(t,e){let a=function(t,e){let a=[],o=t;for(;o<=e;){let t=Math.min(o+5e3-1,e);a.push({from:o,to:t}),o=t+1}return a}(t,e),o="0x"+h.toLowerCase().replace(/^0x/,"").padStart(64,"0"),r=[];for(let t=0;t<a.length;t+=1){let e=a.slice(t,t+1).flatMap((e,a)=>[c({jsonrpc:"2.0",id:1e3+t+2*a,method:"eth_getLogs",params:[{fromBlock:n(e.from),toBlock:n(e.to),address:k,topics:[b,o]}]}),c({jsonrpc:"2.0",id:1e3+t+2*a+1,method:"eth_getLogs",params:[{fromBlock:n(e.from),toBlock:n(e.to),address:k,topics:[b,null,o]}]})]),s=await Promise.all(e),l=new Set;for(let t of s)for(let e of t?.result||[]){let t=`${e.transactionHash}:${e.logIndex}`;l.has(t)||(l.add(t),r.push(e))}await new Promise(t=>setTimeout(t,500))}return r}async function f(t){if(0===t.length)return new Map;let e=t.map((t,e)=>({jsonrpc:"2.0",id:e+1,method:"eth_getBlockByNumber",params:[n(t),!1]})),a=[];for(let t=0;t<e.length;t+=50){let o=e.slice(t,t+50),r=await c(o);a.push(...r),await new Promise(t=>setTimeout(t,200))}let o=new Map;for(let t of a)t?.result&&o.set(parseInt(t.result.number,16),parseInt(t.result.timestamp,16));return o}function g(t,e,a){for(let o of(t.playerDays||(t.playerDays={}),e)){let e=i(o.topics?.[1]),r=i(o.topics?.[2]);if(e!==h&&r!==h)continue;let s=BigInt(o.data||"0x0");if(0n===s)continue;let l=a.get(parseInt(o.blockNumber,16))||0,n=l>0?new Date(1e3*l):new Date,c=`${n.getUTCFullYear()}-${String(n.getUTCMonth()+1).padStart(2,"0")}-${String(n.getUTCDate()).padStart(2,"0")}`;if(r===h&&l>0&&(t.volumeByDay[c]=(BigInt(t.volumeByDay[c]||"0")+s).toString(),t.totalVolume=(BigInt(t.totalVolume||"0")+s).toString()),e===h){let e=t.totals[r]||{won:"0",lost:"0",txs:0,games:0};e.won=(BigInt(e.won)+s).toString(),e.txs+=1,t.totals[r]=e,t.playerDays[r]||(t.playerDays[r]={});let a=t.playerDays[r][c]||{won:"0",lost:"0",txs:0,games:0};a.won=(BigInt(a.won)+s).toString(),a.txs+=1,t.playerDays[r][c]=a}else{let a=t.totals[e]||{won:"0",lost:"0",txs:0,games:0};a.lost=(BigInt(a.lost)+s).toString(),a.txs+=1,a.games=(a.games||0)+1,t.totals[e]=a,t.playerDays[e]||(t.playerDays[e]={});let o=t.playerDays[e][c]||{won:"0",lost:"0",txs:0,games:0};o.lost=(BigInt(o.lost)+s).toString(),o.txs+=1,o.games=(o.games||0)+1,t.playerDays[e][c]=o}}}function p(t,e){let a={};for(let[o,r]of Object.entries(t))for(let[t,s]of Object.entries(r))e&&t<e||(a[o]||(a[o]={won:0n,lost:0n,txs:0,games:0}),a[o].won+=BigInt(s.won),a[o].lost+=BigInt(s.lost),a[o].txs+=s.txs,a[o].games+=s.games||0);let o=Object.entries(a).map(([t,e])=>({player:t,won:e.won.toString(),lost:e.lost.toString(),net:(e.won-e.lost).toString(),txs:e.txs,games:e.games}));return o.sort((t,e)=>{let a=BigInt(t.net),o=BigInt(e.net);return a===o?e.games-t.games:a>o?-1:1}),o.slice(0,10)}function y(t){let e=new Date;return e.setUTCDate(e.getUTCDate()-t),`${e.getUTCFullYear()}-${String(e.getUTCMonth()+1).padStart(2,"0")}-${String(e.getUTCDate()).padStart(2,"0")}`}function d(t,e,a){let o=Object.entries(t.totals).map(([t,e])=>({player:t,won:e.won,lost:e.lost,net:(BigInt(e.won)-BigInt(e.lost)).toString(),txs:e.txs,games:e.games||0}));o.sort((t,e)=>{let a=BigInt(t.net),o=BigInt(e.net);return a===o?e.games-t.games:a>o?-1:1});let r=Object.entries(t.volumeByDay).sort((t,e)=>t[0].localeCompare(e[0])).map(([t,e])=>({day:t,volume:e})),s=a&&a>0?l():e||l(),n=t.playerDays||{},i=p(n,y(7)),c=p(n,y(30));return{rows:o.slice(0,10),rowsWeekly:i,rowsMonthly:c,volumeSeries:r,totalVolume:t.totalVolume||"0",lastBlock:t.lastBlock,updatedAt:s}}async function w(t,e){let a=!!(process.env.KV_REST_API_URL||process.env.UPSTASH_REDIS_REST_URL);if("POST"===t.method)try{let{logs:o,toBlock:s}=t.body;if(!o||!Array.isArray(o)||!s)return e.status(400).json({ok:!1,error:"Missing logs or toBlock"});let l=null;if(a)try{l=await r.kv.get(v)}catch{}if(l||(l={lastBlock:0,totals:{},volumeByDay:{},totalVolume:"0",playerDays:{}}),s<=l.lastBlock)return e.status(200).json({ok:!0,skipped:!0,message:"Server already has newer data"});let n=[...new Set(o.map(t=>parseInt(t.blockNumber,16)))],i=new Map;try{i=await f(n)}catch(e){let t=Math.floor(Date.now()/1e3);for(let e of n)i.set(e,t)}if(g(l,o,i),l.lastBlock=s,a)try{await r.kv.set(v,l)}catch(t){console.error("Failed to save client sync state:",t)}let c=d(l,void 0,o.length);if(x=c,a)try{await r.kv.set(P,c)}catch(t){console.error("Failed to save client sync cache:",t)}return e.status(200).json({ok:!0,saved:!0,totalVolume:l.totalVolume,lastBlock:l.lastBlock})}catch(t){return e.status(500).json({ok:!1,error:t?.message||"Server error"})}let o=t.query?.fresh==="1",s="string"==typeof t.query?.player?t.query.player.toLowerCase().trim():"";if(s&&/^0x[a-f0-9]{40}$/.test(s)){let t=null;if(a)try{t=await r.kv.get(v)}catch{}if(!t)return e.status(200).json({ok:!0,playerData:null,reason:"No state available yet"});let o=t.totals[s],l=t.playerDays?.[s];if(!o&&!l)return e.status(200).json({ok:!0,playerData:null,reason:"Player not found"});let n=l?Object.entries(l).sort((t,e)=>t[0].localeCompare(e[0])).map(([t,e])=>({day:t,won:e.won,lost:e.lost,net:(BigInt(e.won)-BigInt(e.lost)).toString(),txs:e.txs,games:e.games||0})):[],i=o||{won:"0",lost:"0",txs:0,games:0};return e.status(200).json({ok:!0,playerData:{address:s,days:n,totals:{won:i.won,lost:i.lost,net:(BigInt(i.won)-BigInt(i.lost)).toString(),txs:i.txs,games:i.games||0}}})}if(!o){let t=x,o="memory";if(!t&&a)try{(t=await r.kv.get(P))&&(x=t,o="kv")}catch{}if(t)try{let a=await u(),r=t.lastBlock<a.num-100;return e.status(200).json({ok:!0,...t,source:o,needsMoreSync:r,syncedTo:t.lastBlock,latestBlock:a.num})}catch{return e.status(200).json({ok:!0,...t,source:o})}}let l=null;if(a)try{l=await r.kv.get(v)}catch(t){t?.message}l||(l={lastBlock:0,totals:{},volumeByDay:{},totalVolume:"0",playerDays:{}});try{let t=await u();l.lastBlock>t.num&&(console.warn(`USDM state lastBlock ${l.lastBlock} > latest ${t.num}, resetting`),l={lastBlock:0,totals:{},volumeByDay:{},totalVolume:"0",playerDays:{}});let o=l.lastBlock>0?l.lastBlock+1:5721028,s=t.num,n=Math.min(o+5e4-1,s),i=n<s,c=n-o+1,p=0;if(o<=n){let t=await m(o,n);if(p=t.length,t.length>0){let e=[...new Set(t.map(t=>parseInt(t.blockNumber,16)))],a=await f(e);g(l,t,a)}if(l.lastBlock=n,a)try{await r.kv.set(v,l)}catch(t){console.error("Failed to save USDM state:",t)}}let y=x?.updatedAt,w=d(l,y,p);if(x=w,a)try{await r.kv.set(P,w)}catch(t){console.error("Failed to save USDM cache:",t)}return e.status(200).json({ok:!0,...w,source:"fresh",needsMoreSync:i,syncedTo:n,latestBlock:s,debug:{fromBlock:o,toBlock:n,blocksToScan:c,logsFound:p,stateLastBlock:l.lastBlock,totalVolume:l.totalVolume}})}catch(s){let t=s?.message||String(s);if(console.error("USDM sync error:",t),x)return e.status(200).json({ok:!0,...x,warning:t,source:"memory-fallback"});if(a)try{let a=await r.kv.get(P);if(a)return x=a,e.status(200).json({ok:!0,...a,warning:t,source:"kv-fallback"})}catch{}let o=d(l,void 0,0);return e.status(200).json({ok:!0,...o,warning:t,source:"state-fallback"})}}o()}catch(t){o(t)}})},7153:(t,e)=>{var a;Object.defineProperty(e,"x",{enumerable:!0,get:function(){return a}}),function(t){t.PAGES="PAGES",t.PAGES_API="PAGES_API",t.APP_PAGE="APP_PAGE",t.APP_ROUTE="APP_ROUTE"}(a||(a={}))},1802:(t,e,a)=>{t.exports=a(145)}};var e=require("../../webpack-api-runtime.js");e.C(t);var a=e(e.s=3847);module.exports=a})();