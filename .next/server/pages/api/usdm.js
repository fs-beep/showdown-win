"use strict";(()=>{var t={};t.id=462,t.ids=[462],t.modules={145:t=>{t.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},1467:t=>{t.exports=import("@vercel/kv")},6249:(t,e)=>{Object.defineProperty(e,"l",{enumerable:!0,get:function(){return function t(e,o){return o in e?e[o]:"then"in e&&"function"==typeof e.then?e.then(e=>t(e,o)):"function"==typeof e&&"default"===o?e:void 0}}})},3847:(t,e,o)=>{o.a(t,async(t,a)=>{try{o.r(e),o.d(e,{config:()=>u,default:()=>c,routeModule:()=>f});var r=o(1802),s=o(7153),l=o(6249),n=o(2466),i=t([n]);n=(i.then?(await i)():i)[0];let c=(0,l.l)(n,"default"),u=(0,l.l)(n,"config"),f=new r.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/usdm",pathname:"/api/usdm",bundlePath:"",filename:""},userland:n});a()}catch(t){a(t)}})},2466:(t,e,o)=>{o.a(t,async(t,a)=>{try{o.r(e),o.d(e,{default:()=>w});var r=o(1467),s=t([r]);r=(s.then?(await s)():s)[0];let h="0x7b8df4195eda5b193304eecb5107de18b6557d24",k="0xfafddbb3fc7688494971a79cc65dca3ef82079e7",B=[process.env.GAME_RESULTS_RPC_URL,process.env.MAINNET_RPC_URL,"https://mainnet.megaeth.com/rpc"].filter(Boolean),b="0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",S=0,v="usdm:state:v12",P="usdm:cache:v12",x=null;function l(){return Date.now()}function n(t){return"0x"+t.toString(16)}function i(t){return t?"0x"+t.slice(-40).toLowerCase():""}async function c(t){let e=null;for(let o=0;o<B.length;o++){let a=B[(S+o)%B.length];for(let r=0;r<5;r+=1)try{let s=new AbortController,l=setTimeout(()=>s.abort(),15e3),n=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),signal:s.signal});if(clearTimeout(l),429===n.status||502===n.status||503===n.status||504===n.status){e=Error(`RPC HTTP ${n.status}`);let t=2e3*Math.pow(2,r)+1e3*Math.random();await new Promise(e=>setTimeout(e,t));continue}if(!n.ok)throw Error(`RPC HTTP ${n.status}`);let i=await n.json();if(Array.isArray(i)){let t=i.find(t=>t?.error);if(t){let o=t.error?.message||"RPC batch error";if(o.toLowerCase().includes("upstream")||o.toLowerCase().includes("timeout")){e=Error(o);break}throw Error(o)}}else if(i?.error){let t=i.error?.message||"RPC error";if(t.toLowerCase().includes("upstream")||t.toLowerCase().includes("timeout")){e=Error(t);break}throw Error(t)}return S=(S+o)%B.length,i}catch(t){if(e=t,t?.name==="AbortError")break;await new Promise(t=>setTimeout(t,2e3+1e3*Math.random()))}}throw e||Error("All RPCs failed")}async function u(){let t=await c({jsonrpc:"2.0",id:1,method:"eth_getBlockByNumber",params:["latest",!1]});if(!t?.result)throw Error("Block not found");return{num:parseInt(t.result.number,16),ts:parseInt(t.result.timestamp,16)}}async function f(t,e){let o=function(t,e){let o=[],a=t;for(;a<=e;){let t=Math.min(a+5e3-1,e);o.push({from:a,to:t}),a=t+1}return o}(t,e),a="0x"+h.toLowerCase().replace(/^0x/,"").padStart(64,"0"),r=[];for(let t=0;t<o.length;t+=1){let e=o.slice(t,t+1).flatMap((e,o)=>[c({jsonrpc:"2.0",id:1e3+t+2*o,method:"eth_getLogs",params:[{fromBlock:n(e.from),toBlock:n(e.to),address:k,topics:[b,a]}]}),c({jsonrpc:"2.0",id:1e3+t+2*o+1,method:"eth_getLogs",params:[{fromBlock:n(e.from),toBlock:n(e.to),address:k,topics:[b,null,a]}]})]),s=await Promise.all(e),l=new Set;for(let t of s)for(let e of t?.result||[]){let t=`${e.transactionHash}:${e.logIndex}`;l.has(t)||(l.add(t),r.push(e))}await new Promise(t=>setTimeout(t,500))}return r}async function m(t){if(0===t.length)return new Map;let e=t.map((t,e)=>({jsonrpc:"2.0",id:e+1,method:"eth_getBlockByNumber",params:[n(t),!1]})),o=[];for(let t=0;t<e.length;t+=50){let a=e.slice(t,t+50),r=await c(a);o.push(...r),await new Promise(t=>setTimeout(t,200))}let a=new Map;for(let t of o)t?.result&&a.set(parseInt(t.result.number,16),parseInt(t.result.timestamp,16));return a}function d(t,e,o){for(let a of(t.playerDays||(t.playerDays={}),e)){let e=i(a.topics?.[1]),r=i(a.topics?.[2]);if(e!==h&&r!==h)continue;let s=BigInt(a.data||"0x0");if(0n===s)continue;let l=o.get(parseInt(a.blockNumber,16))||0,n=l>0?new Date(1e3*l):new Date,c=`${n.getUTCFullYear()}-${String(n.getUTCMonth()+1).padStart(2,"0")}-${String(n.getUTCDate()).padStart(2,"0")}`;if(r===h&&l>0&&(t.volumeByDay[c]=(BigInt(t.volumeByDay[c]||"0")+s).toString(),t.totalVolume=(BigInt(t.totalVolume||"0")+s).toString()),e===h){let e=t.totals[r]||{won:"0",lost:"0",txs:0};e.won=(BigInt(e.won)+s).toString(),e.txs+=1,t.totals[r]=e,t.playerDays[r]||(t.playerDays[r]={});let o=t.playerDays[r][c]||{won:"0",lost:"0",txs:0};o.won=(BigInt(o.won)+s).toString(),o.txs+=1,t.playerDays[r][c]=o}else{let o=t.totals[e]||{won:"0",lost:"0",txs:0};o.lost=(BigInt(o.lost)+s).toString(),o.txs+=1,t.totals[e]=o,t.playerDays[e]||(t.playerDays[e]={});let a=t.playerDays[e][c]||{won:"0",lost:"0",txs:0};a.lost=(BigInt(a.lost)+s).toString(),a.txs+=1,t.playerDays[e][c]=a}}}function p(t,e){let o={};for(let[a,r]of Object.entries(t))for(let[t,s]of Object.entries(r))e&&t<e||(o[a]||(o[a]={won:0n,lost:0n,txs:0}),o[a].won+=BigInt(s.won),o[a].lost+=BigInt(s.lost),o[a].txs+=s.txs);let a=Object.entries(o).map(([t,e])=>({player:t,won:e.won.toString(),lost:e.lost.toString(),net:(e.won-e.lost).toString(),txs:e.txs}));return a.sort((t,e)=>{let o=BigInt(t.net),a=BigInt(e.net);return o===a?e.txs-t.txs:o>a?-1:1}),a.slice(0,10)}function y(t){let e=new Date;return e.setUTCDate(e.getUTCDate()-t),`${e.getUTCFullYear()}-${String(e.getUTCMonth()+1).padStart(2,"0")}-${String(e.getUTCDate()).padStart(2,"0")}`}function g(t,e,o){let a=Object.entries(t.totals).map(([t,e])=>({player:t,won:e.won,lost:e.lost,net:(BigInt(e.won)-BigInt(e.lost)).toString(),txs:e.txs}));a.sort((t,e)=>{let o=BigInt(t.net),a=BigInt(e.net);return o===a?e.txs-t.txs:o>a?-1:1});let r=Object.entries(t.volumeByDay).sort((t,e)=>t[0].localeCompare(e[0])).map(([t,e])=>({day:t,volume:e})),s=o&&o>0?l():e||l(),n=t.playerDays||{},i=p(n,y(7)),c=p(n,y(30));return{rows:a.slice(0,10),rowsWeekly:i,rowsMonthly:c,volumeSeries:r,totalVolume:t.totalVolume||"0",lastBlock:t.lastBlock,updatedAt:s}}async function w(t,e){let o=!!(process.env.KV_REST_API_URL||process.env.UPSTASH_REDIS_REST_URL);if("POST"===t.method)try{let{logs:a,toBlock:s}=t.body;if(!a||!Array.isArray(a)||!s)return e.status(400).json({ok:!1,error:"Missing logs or toBlock"});let l=null;if(o)try{l=await r.kv.get(v)}catch{}if(l||(l={lastBlock:0,totals:{},volumeByDay:{},totalVolume:"0",playerDays:{}}),s<=l.lastBlock)return e.status(200).json({ok:!0,skipped:!0,message:"Server already has newer data"});let n=[...new Set(a.map(t=>parseInt(t.blockNumber,16)))],i=new Map;try{i=await m(n)}catch(e){let t=Math.floor(Date.now()/1e3);for(let e of n)i.set(e,t)}if(d(l,a,i),l.lastBlock=s,o)try{await r.kv.set(v,l)}catch(t){console.error("Failed to save client sync state:",t)}let c=g(l,void 0,a.length);if(x=c,o)try{await r.kv.set(P,c)}catch(t){console.error("Failed to save client sync cache:",t)}return e.status(200).json({ok:!0,saved:!0,totalVolume:l.totalVolume,lastBlock:l.lastBlock})}catch(t){return e.status(500).json({ok:!1,error:t?.message||"Server error"})}if(t.query?.fresh!=="1"){let t=x,a="memory";if(!t&&o)try{(t=await r.kv.get(P))&&(x=t,a="kv")}catch{}if(t)try{let o=await u(),r=t.lastBlock<o.num-100;return e.status(200).json({ok:!0,...t,source:a,needsMoreSync:r,syncedTo:t.lastBlock,latestBlock:o.num})}catch{return e.status(200).json({ok:!0,...t,source:a})}}let a=null;if(o)try{a=await r.kv.get(v)}catch(t){t?.message}a||(a={lastBlock:0,totals:{},volumeByDay:{},totalVolume:"0",playerDays:{}});try{let t=await u();a.lastBlock>t.num&&(console.warn(`USDM state lastBlock ${a.lastBlock} > latest ${t.num}, resetting`),a={lastBlock:0,totals:{},volumeByDay:{},totalVolume:"0",playerDays:{}});let s=a.lastBlock>0?a.lastBlock+1:5721028,l=t.num,n=Math.min(s+5e4-1,l),i=n<l,c=n-s+1,p=0;if(s<=n){let t=await f(s,n);if(p=t.length,t.length>0){let e=[...new Set(t.map(t=>parseInt(t.blockNumber,16)))],o=await m(e);d(a,t,o)}if(a.lastBlock=n,o)try{await r.kv.set(v,a)}catch(t){console.error("Failed to save USDM state:",t)}}let y=x?.updatedAt,w=g(a,y,p);if(x=w,o)try{await r.kv.set(P,w)}catch(t){console.error("Failed to save USDM cache:",t)}return e.status(200).json({ok:!0,...w,source:"fresh",needsMoreSync:i,syncedTo:n,latestBlock:l,debug:{fromBlock:s,toBlock:n,blocksToScan:c,logsFound:p,stateLastBlock:a.lastBlock,totalVolume:a.totalVolume}})}catch(l){let t=l?.message||String(l);if(console.error("USDM sync error:",t),x)return e.status(200).json({ok:!0,...x,warning:t,source:"memory-fallback"});if(o)try{let o=await r.kv.get(P);if(o)return x=o,e.status(200).json({ok:!0,...o,warning:t,source:"kv-fallback"})}catch{}let s=g(a,void 0,0);return e.status(200).json({ok:!0,...s,warning:t,source:"state-fallback"})}}a()}catch(t){a(t)}})},7153:(t,e)=>{var o;Object.defineProperty(e,"x",{enumerable:!0,get:function(){return o}}),function(t){t.PAGES="PAGES",t.PAGES_API="PAGES_API",t.APP_PAGE="APP_PAGE",t.APP_ROUTE="APP_ROUTE"}(o||(o={}))},1802:(t,e,o)=>{t.exports=o(145)}};var e=require("../../webpack-api-runtime.js");e.C(t);var o=e(e.s=3847);module.exports=o})();